{% extends "base.html" %}

{% block title %}Messages - Retreat Housing{% endblock %}

{% block content %}
<div class="flex flex-wrap justify-between items-center pt-6 pb-4 mb-6 border-b border-gray-200">
    <h1 class="text-3xl font-semibold text-primary-800 heading">Messages</h1>
    <div class="flex space-x-2">
        <a href="{{ url_for('admin.send_message') }}" class="btn-brand-primary">
            <i class="bi bi-plus-circle mr-2"></i>Send Message
        </a>
        <a href="{{ url_for('admin.mark_all_messages_read') }}" class="px-4 py-2 text-sm text-primary-800 border border-primary-800 rounded-md hover:bg-primary-50 transition-colors">Mark All Read</a>
    </div>
</div>

<!-- Statistics Cards -->
{% if messages %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="card-brand p-6">
        <div class="flex items-center">
            <div class="bg-blue-100 rounded-full p-3">
                <i class="bi bi-envelope text-blue-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <div class="text-2xl font-semibold text-gray-900">{{ messages | length }}</div>
                <div class="text-sm text-gray-500">Total Messages</div>
            </div>
        </div>
    </div>
    
    <div class="card-brand p-6">
        <div class="flex items-center">
            <div class="bg-green-100 rounded-full p-3">
                <i class="bi bi-arrow-up text-green-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <div class="text-2xl font-semibold text-gray-900">
                    {{ messages | selectattr("sender_id", "equalto", current_user.id) | list | length }}
                </div>
                <div class="text-sm text-gray-500">Sent</div>
            </div>
        </div>
    </div>
    
    <div class="card-brand p-6">
        <div class="flex items-center">
            <div class="bg-yellow-100 rounded-full p-3">
                <i class="bi bi-arrow-down text-yellow-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <div class="text-2xl font-semibold text-gray-900">
                    {{ messages | selectattr("recipient_id", "equalto", current_user.id) | list | length }}
                </div>
                <div class="text-sm text-gray-500">Received</div>
            </div>
        </div>
    </div>
    
    <div class="card-brand p-6">
        <div class="flex items-center">
            <div class="bg-red-100 rounded-full p-3">
                <i class="bi bi-envelope-exclamation text-red-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <div class="text-2xl font-semibold text-gray-900">
                    {{ messages | selectattr("recipient_id", "equalto", current_user.id) | selectattr("is_read", "equalto", false) | list | length }}
                </div>
                <div class="text-sm text-gray-500">Unread</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Messages List -->
<div class="card-brand overflow-hidden">
    {% if messages %}
        <div class="divide-y divide-gray-200">
            {% for message in messages %}
            <div class="p-6 hover:bg-gray-50 transition-colors relative {% if message.recipient_id == current_user.id and not message.is_read %}bg-blue-50{% endif %}">
                <div class="flex items-start space-x-4">
                    <!-- Avatar -->
                    <div class="flex-shrink-0">
                        {% if message.sender_id == current_user.id %}
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="bi bi-arrow-up text-green-600"></i>
                        </div>
                        {% else %}
                        <div class="bg-blue-100 rounded-full p-3">
                            <i class="bi bi-person text-blue-600"></i>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Message Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <div class="flex items-center space-x-2">
                                    {% if message.sender_id == current_user.id %}
                                    <span class="text-sm font-medium text-gray-900">To: {{ message.recipient.full_name }}</span>
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                        <i class="bi bi-arrow-up mr-1"></i>Sent
                                    </span>
                                    {% else %}
                                    <span class="text-sm font-medium text-gray-900">From: {{ message.sender.full_name }}</span>
                                    {% if not message.is_read %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                                        <i class="bi bi-envelope-exclamation mr-1"></i>Unread
                                    </span>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                {% if message.property %}
                                <div class="text-xs text-gray-500 mt-1">
                                    <i class="bi bi-building mr-1"></i>Property: {{ message.property.address[:50] }}{% if message.property.address|length > 50 %}...{% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <i class="bi bi-clock"></i>
                                <time>{{ message.sent_at.strftime('%b %d, %Y at %I:%M %p') }}</time>
                            </div>
                        </div>
                        
                        <!-- Message Text -->
                        <div class="text-sm text-gray-700 mb-3 bg-white rounded-lg p-4 border border-gray-200">
                            {{ message.message_text | truncate(200) }}
                            {% if message.message_text|length > 200 %}
                            <button class="text-primary-600 hover:text-primary-800 ml-2 font-medium" onclick="showFullMessage({{ message.id }})">
                                Read more
                            </button>
                            {% endif %}
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button class="text-primary-600 hover:text-primary-800 text-sm font-medium" onclick="showFullMessage({{ message.id }})">
                                <i class="bi bi-eye mr-1"></i>View Full
                            </button>
                            {% if message.sender_id != current_user.id %}
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="replyToMessage({{ message.sender_id }}, '{{ message.sender.full_name }}', {{ message.property_id or 'null' }})">
                                <i class="bi bi-reply mr-1"></i>Reply
                            </button>
                            {% if not message.is_read %}
                            <button class="text-green-600 hover:text-green-800 text-sm font-medium" onclick="markAsRead({{ message.id }})">
                                <i class="bi bi-check mr-1"></i>Mark as Read
                            </button>
                            {% endif %}
                            {% endif %}
                            <button class="text-red-600 hover:text-red-800 text-sm font-medium" onclick="deleteMessage({{ message.id }})">
                                <i class="bi bi-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Full message content (hidden by default) -->
                <div id="full-message-{{ message.id }}" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="font-medium text-gray-900 mb-2">Full Message:</h4>
                    <div class="text-sm text-gray-700 whitespace-pre-wrap">{{ message.message_text }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-12">
            <div class="bg-gray-100 rounded-full p-6 w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                <i class="bi bi-chat-dots text-gray-400 text-3xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No messages</h3>
            <p class="text-gray-500 mb-6">Start a conversation by sending your first message.</p>
            <a href="{{ url_for('admin.send_message') }}" class="btn-brand-primary">
                <i class="bi bi-plus-circle mr-2"></i>Send Message
            </a>
        </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="bi bi-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4">Delete Message</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to delete this message? This action cannot be undone.</p>
            </div>
            <div class="flex gap-3 mt-4">
                <button id="cancelDelete" class="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors flex-1">
                    Cancel
                </button>
                <button id="confirmDelete" class="px-4 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex-1">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Reply Modal -->
<div id="replyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-6 border max-w-2xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Quick Reply</h3>
            <button onclick="closeReplyModal()" class="text-gray-400 hover:text-gray-600">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <form id="quickReplyForm" action="{{ url_for('admin.send_message') }}" method="POST">
            <input type="hidden" name="recipient_id" id="reply-recipient-id">
            <input type="hidden" name="property_id" id="reply-property-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">To:</label>
                <div id="reply-recipient-name" class="text-sm text-gray-900 bg-gray-50 p-2 rounded"></div>
            </div>
            <div class="mb-4">
                <label for="reply-message" class="block text-sm font-medium text-gray-700 mb-2">Message:</label>
                <textarea name="message_text" id="reply-message" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeReplyModal()" class="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                    <i class="bi bi-send mr-2"></i>Send Reply
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let messageToDelete = null;

function showFullMessage(messageId) {
    const fullMessageDiv = document.getElementById(`full-message-${messageId}`);
    fullMessageDiv.classList.toggle('hidden');
}

function deleteMessage(messageId) {
    messageToDelete = messageId;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function replyToMessage(senderId, senderName, propertyId) {
    document.getElementById('reply-recipient-name').textContent = senderName;
    document.getElementById('reply-recipient-id').value = senderId;
    document.getElementById('reply-property-id').value = propertyId || '';
    document.getElementById('reply-message').value = '';
    document.getElementById('replyModal').classList.remove('hidden');
}

function closeReplyModal() {
    document.getElementById('replyModal').classList.add('hidden');
}

function markAsRead(messageId) {
    window.location.href = `{{ url_for('admin.mark_message_read', message_id=0) }}`.replace('0', messageId);
}

// Delete modal handlers
document.getElementById('cancelDelete').addEventListener('click', function() {
    document.getElementById('deleteModal').classList.add('hidden');
    messageToDelete = null;
});

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (messageToDelete) {
        window.location.href = `{{ url_for('admin.delete_message', message_id=0) }}`.replace('0', messageToDelete);
    }
});

// Close modals when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.classList.add('hidden');
        messageToDelete = null;
    }
});

document.getElementById('replyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeReplyModal();
    }
});
</script>
{% endblock %}