{% extends "base.html" %}

{% block title %}Request Maintenance - Retreat Housing{% endblock %}

{% block content %}
<div class="flex flex-wrap justify-between items-center pt-6 pb-4 mb-6 border-b border-gray-200">
    <h1 class="text-3xl font-semibold text-primary-800 heading">Request Maintenance</h1>
    <div class="flex space-x-2">
        <a href="{{ url_for('tenant.maintenance') }}" class="px-4 py-2 text-sm text-primary-800 border border-primary-800 rounded-md hover:bg-primary-50 transition-colors">
            <i class="bi bi-arrow-left mr-2"></i>Back to Requests
        </a>
    </div>
</div>

<!-- Property Information -->
{% if active_lease %}
<div class="card-brand p-6 mb-6 bg-blue-50 border border-blue-200">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i class="bi bi-house text-blue-600 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">Property Information</h3>
            <div class="mt-1 text-sm text-blue-700">
                <p><strong>Address:</strong> {{ active_lease.property.address }}</p>
                <p><strong>Property Type:</strong> {{ active_lease.property.property_type.title() }}</p>
                {% if active_lease.property.bedrooms %}
                <p><strong>Bedrooms:</strong> {{ active_lease.property.bedrooms }} | <strong>Bathrooms:</strong> {{ active_lease.property.bathrooms }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Maintenance Request Form -->
<div class="max-w-2xl">
    <div class="card-brand p-6">
        <form method="POST">
            {{ form.hidden_tag() }}
            
            <div class="space-y-6">
                <!-- Property Selection (Hidden for tenants since they only have one property) -->
                {{ form.property_id(style="display: none;") }}
                
                <!-- Request Title -->
                <div>
                    {{ form.title.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.title(class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent", placeholder="Brief description of the issue") }}
                    {% if form.title.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.title.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="mt-1 text-sm text-gray-500">Provide a clear, concise title for your maintenance request</div>
                </div>
                
                <!-- Priority Level -->
                <div>
                    {{ form.priority.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.priority(class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent") }}
                    {% if form.priority.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.priority.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="mt-1 text-sm text-gray-500">
                        <strong>Urgent:</strong> Safety hazards, no heat/AC, major water leaks<br>
                        <strong>High:</strong> Non-functioning appliances, minor leaks, electrical issues<br>
                        <strong>Medium:</strong> Cosmetic repairs, minor fixtures<br>
                        <strong>Low:</strong> Non-essential improvements
                    </div>
                </div>
                
                <!-- Detailed Description -->
                <div>
                    {{ form.description.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.description(class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent", rows="6", placeholder="Please provide a detailed description of the maintenance issue, including location, when it started, and any other relevant information...") }}
                    {% if form.description.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.description.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="mt-1 text-sm text-gray-500">
                        <span id="char-count">0</span> characters - Include as much detail as possible
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200">
                <a href="{{ url_for('tenant.maintenance') }}" class="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="btn-brand-primary" id="submit-btn">
                    <i class="bi bi-send mr-2"></i>Submit Request
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Quick Issue Templates -->
<div class="card-brand p-6 mt-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Common Maintenance Issues</h3>
    <p class="text-sm text-gray-600 mb-4">Click on a common issue to auto-fill the form with a template:</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <button type="button" onclick="useTemplate('plumbing')" class="text-left p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
            <div class="flex items-center mb-2">
                <i class="bi bi-droplet text-blue-600 text-lg mr-2"></i>
                <div class="font-medium text-blue-900">Plumbing Issue</div>
            </div>
            <div class="text-sm text-blue-700">Leaks, clogs, low water pressure</div>
        </button>
        
        <button type="button" onclick="useTemplate('electrical')" class="text-left p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors">
            <div class="flex items-center mb-2">
                <i class="bi bi-lightning text-yellow-600 text-lg mr-2"></i>
                <div class="font-medium text-yellow-900">Electrical Problem</div>
            </div>
            <div class="text-sm text-yellow-700">Outlets, switches, lighting issues</div>
        </button>
        
        <button type="button" onclick="useTemplate('hvac')" class="text-left p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
            <div class="flex items-center mb-2">
                <i class="bi bi-thermometer text-green-600 text-lg mr-2"></i>
                <div class="font-medium text-green-900">HVAC Issue</div>
            </div>
            <div class="text-sm text-green-700">Heating, cooling, ventilation</div>
        </button>
        
        <button type="button" onclick="useTemplate('appliance')" class="text-left p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
            <div class="flex items-center mb-2">
                <i class="bi bi-gear text-purple-600 text-lg mr-2"></i>
                <div class="font-medium text-purple-900">Appliance Repair</div>
            </div>
            <div class="text-sm text-purple-700">Refrigerator, washer, dryer, etc.</div>
        </button>
        
        <button type="button" onclick="useTemplate('pest')" class="text-left p-4 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
            <div class="flex items-center mb-2">
                <i class="bi bi-bug text-red-600 text-lg mr-2"></i>
                <div class="font-medium text-red-900">Pest Control</div>
            </div>
            <div class="text-sm text-red-700">Insects, rodents, other pests</div>
        </button>
        
        <button type="button" onclick="useTemplate('other')" class="text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
            <div class="flex items-center mb-2">
                <i class="bi bi-tools text-gray-600 text-lg mr-2"></i>
                <div class="font-medium text-gray-900">General Repair</div>
            </div>
            <div class="text-sm text-gray-700">Doors, windows, fixtures</div>
        </button>
    </div>
</div>

<!-- Emergency Contact Information -->
<div class="card-brand p-6 mt-6 bg-red-50 border border-red-200">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i class="bi bi-exclamation-triangle text-red-600 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">Emergency Situations</h3>
            <div class="mt-2 text-sm text-red-700">
                <p class="mb-2">For true emergencies (gas leaks, electrical hazards, major water damage, security issues), contact:</p>
                <div class="bg-red-100 p-3 rounded-md">
                    <p class="font-medium">Emergency Maintenance Hotline</p>
                    <p class="text-lg font-bold">(555) 123-HELP</p>
                    <p class="text-xs">Available 24/7 for genuine emergencies only</p>
                </div>
                <p class="mt-2 text-xs">For non-emergency issues, please use this form so we can properly track and prioritize your request.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Character counter for description
document.getElementById('description').addEventListener('input', function() {
    const charCount = this.value.length;
    document.getElementById('char-count').textContent = charCount;
});

// Common issue templates
const templates = {
    'plumbing': {
        title: 'Plumbing Issue',
        description: `Location: [Specify room/area - e.g., kitchen sink, bathroom shower]
Issue: [Describe the problem - e.g., water leak, clogged drain, low water pressure]
When it started: [When did you first notice this issue?]
Severity: [Is water currently flowing/leaking? How much?]
Actions taken: [Have you tried anything to fix it?]

Additional details: [Any other relevant information]`,
        priority: 'medium'
    },
    
    'electrical': {
        title: 'Electrical Issue',
        description: `Location: [Specify room/area and exact location]
Issue: [Describe the problem - e.g., outlet not working, light flickering, circuit breaker tripping]
When it started: [When did you first notice this issue?]
Safety concerns: [Any sparks, burning smells, or other safety issues?]
Affected areas: [What else is not working?]

Additional details: [Any other relevant information]`,
        priority: 'high'
    },
    
    'hvac': {
        title: 'HVAC Issue',
        description: `System: [Heating/Cooling/Ventilation]
Issue: [Describe the problem - e.g., not heating/cooling, strange noises, poor air flow]
When it started: [When did you first notice this issue?]
Current temperature: [What temperature is it currently?]
Thermostat setting: [What is the thermostat set to?]
Filter status: [When was the filter last changed?]

Additional details: [Any other relevant information]`,
        priority: 'high'
    },
    
    'appliance': {
        title: 'Appliance Repair',
        description: `Appliance: [Specify which appliance - refrigerator, washer, dryer, dishwasher, etc.]
Issue: [Describe the problem - e.g., not working, making noise, leaking]
When it started: [When did you first notice this issue?]
Error codes: [Any error messages or codes displayed?]
Actions taken: [Have you tried anything to fix it?]

Additional details: [Any other relevant information]`,
        priority: 'medium'
    },
    
    'pest': {
        title: 'Pest Control Request',
        description: `Type of pest: [Specify - ants, roaches, mice, etc.]
Location: [Where have you seen them?]
Frequency: [How often do you see them?]
When noticed: [When did you first notice this issue?]
Severity: [How many have you seen? Is it getting worse?]
Actions taken: [Have you tried any treatments?]

Additional details: [Any other relevant information]`,
        priority: 'medium'
    },
    
    'other': {
        title: 'General Maintenance Request',
        description: `Location: [Specify room/area]
Issue: [Describe the problem in detail]
When it started: [When did you first notice this issue?]
Impact: [How is this affecting your daily life?]
Actions taken: [Have you tried anything to fix it?]

Additional details: [Any other relevant information]`,
        priority: 'medium'
    }
};

function useTemplate(templateType) {
    const template = templates[templateType];
    if (template) {
        document.getElementById('title').value = template.title;
        document.getElementById('description').value = template.description;
        document.getElementById('priority').value = template.priority;
        
        // Update character count
        const event = new Event('input');
        document.getElementById('description').dispatchEvent(event);
        
        // Scroll to form
        document.getElementById('title').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('title').focus();
    }
}

// Form submission with loading state
document.querySelector('form').addEventListener('submit', function() {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split mr-2"></i>Submitting...';
    submitBtn.disabled = true;
});

// Priority level helper
document.getElementById('priority').addEventListener('change', function() {
    const priority = this.value;
    const helpText = {
        'urgent': 'Emergency situations requiring immediate attention (safety hazards, major leaks, no heat/AC)',
        'high': 'Important issues that significantly impact daily life (non-functioning appliances, electrical problems)',
        'medium': 'Standard maintenance issues that should be addressed soon (minor leaks, cosmetic repairs)',
        'low': 'Non-essential improvements or minor issues that can wait'
    };
    
    // You could show this help text in a tooltip or below the select
    console.log(helpText[priority]);
});
</script>
{% endblock %}