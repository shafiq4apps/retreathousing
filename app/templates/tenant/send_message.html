{% extends "base.html" %}

{% block title %}Send Message - Retreat Housing{% endblock %}

{% block content %}
<div class="flex flex-wrap justify-between items-center pt-6 pb-4 mb-6 border-b border-gray-200">
    <h1 class="text-3xl font-semibold text-primary-800 heading">Send Message</h1>
    <div class="flex space-x-2">
        <a href="{{ url_for('tenant.messages') }}" class="px-4 py-2 text-sm text-primary-800 border border-primary-800 rounded-md hover:bg-primary-50 transition-colors">
            <i class="bi bi-arrow-left mr-2"></i>Back to Messages
        </a>
    </div>
</div>

<div class="max-w-2xl">
    <div class="card-brand p-6">
        <form method="POST">
            {{ form.hidden_tag() }}
            
            <div class="space-y-6">
                <!-- Recipient Selection (Read-only for tenants) -->
                <div>
                    {{ form.recipient_id.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.recipient_id(class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent", readonly=true) }}
                    {% if form.recipient_id.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.recipient_id.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="mt-1 text-sm text-gray-500">Sending message to your property manager</div>
                </div>
                
                <!-- Property Selection (Optional) -->
                <div>
                    {{ form.property_id.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.property_id(class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent") }}
                    {% if form.property_id.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.property_id.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="mt-1 text-sm text-gray-500">Select your property or leave as general message</div>
                </div>
                
                <!-- Message Content -->
                <div>
                    {{ form.message_text.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.message_text(class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent", rows="6", placeholder="Type your message here...") }}
                    {% if form.message_text.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.message_text.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="mt-1 text-sm text-gray-500">
                        <span id="char-count">0</span>/1000 characters
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200">
                <a href="{{ url_for('tenant.messages') }}" class="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="btn-brand-primary" id="send-btn">
                    <i class="bi bi-send mr-2"></i>Send Message
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Message Templates for Tenants -->
<div class="card-brand p-6 mt-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Templates</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
            <button type="button" onclick="useTemplate('maintenance-request')" class="w-full text-left p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                <div class="font-medium text-blue-900">Maintenance Request</div>
                <div class="text-sm text-blue-700">Report a maintenance issue</div>
            </button>
            
            <button type="button" onclick="useTemplate('rent-inquiry')" class="w-full text-left p-3 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                <div class="font-medium text-green-900">Rent Inquiry</div>
                <div class="text-sm text-green-700">Question about rent payment</div>
            </button>
            
            <button type="button" onclick="useTemplate('lease-question')" class="w-full text-left p-3 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors">
                <div class="font-medium text-yellow-900">Lease Question</div>
                <div class="text-sm text-yellow-700">Question about lease terms</div>
            </button>
        </div>
        
        <div class="space-y-2">
            <button type="button" onclick="useTemplate('noise-complaint')" class="w-full text-left p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                <div class="font-medium text-purple-900">Noise Complaint</div>
                <div class="text-sm text-purple-700">Report noise issues</div>
            </button>
            
            <button type="button" onclick="useTemplate('access-request')" class="w-full text-left p-3 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                <div class="font-medium text-indigo-900">Access Request</div>
                <div class="text-sm text-indigo-700">Request property access</div>
            </button>
            
            <button type="button" onclick="useTemplate('general')" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                <div class="font-medium text-gray-900">General Message</div>
                <div class="text-sm text-gray-700">General communication</div>
            </button>
        </div>
    </div>
</div>

<!-- Help Section -->
<div class="card-brand p-6 mt-6 bg-blue-50 border border-blue-200">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i class="bi bi-info-circle text-blue-600 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">Message Guidelines</h3>
            <div class="mt-2 text-sm text-blue-700">
                <p>Tips for effective communication with your property manager:</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>Be clear and specific about your request or concern</li>
                    <li>Include relevant details like dates, times, and locations</li>
                    <li>For maintenance issues, describe the problem in detail</li>
                    <li>Use a polite and professional tone</li>
                    <li>Use message templates for common requests</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Character counter
document.getElementById('message_text').addEventListener('input', function() {
    const charCount = this.value.length;
    document.getElementById('char-count').textContent = charCount;
    
    if (charCount > 900) {
        document.getElementById('char-count').className = 'text-red-600 font-medium';
    } else if (charCount > 800) {
        document.getElementById('char-count').className = 'text-yellow-600 font-medium';
    } else {
        document.getElementById('char-count').className = '';
    }
});

// Message templates for tenants
const templates = {
    'maintenance-request': `Dear Property Manager,

I would like to report a maintenance issue in my unit at [Property Address].

Issue Description: [Describe the problem in detail]
Location: [Specific room or area]
Urgency: [Low/Medium/High/Emergency]
Best time for repair: [Your availability]

Please let me know when maintenance can be scheduled to address this issue.

Thank you for your attention to this matter.

Best regards,
[Your Name]`,

    'rent-inquiry': `Dear Property Manager,

I have a question regarding my rent payment for [Month/Year].

[Describe your question or concern - e.g., payment method, due date, amount, etc.]

Could you please provide clarification on this matter?

Thank you for your assistance.

Best regards,
[Your Name]`,

    'lease-question': `Dear Property Manager,

I have a question about my lease agreement at [Property Address].

[Describe your specific question about lease terms, policies, etc.]

I would appreciate clarification on this matter so I can ensure I'm complying with all lease requirements.

Thank you for your time.

Best regards,
[Your Name]`,

    'noise-complaint': `Dear Property Manager,

I would like to report a noise issue that has been affecting my enjoyment of my unit at [Property Address].

Details:
- Date/Time of incidents: [When the noise occurs]
- Type of noise: [Description of the noise]
- Source location: [If known - unit number, common area, etc.]
- Frequency: [How often this occurs]

I would appreciate your assistance in addressing this matter.

Thank you for your attention.

Best regards,
[Your Name]`,

    'access-request': `Dear Property Manager,

I am writing to request access to [specific area or service] at [Property Address].

Reason for request: [Explain why you need access]
Preferred date/time: [When you'd like access]
Duration needed: [How long you'll need access]

Please let me know if this request can be accommodated and what procedures I need to follow.

Thank you for your consideration.

Best regards,
[Your Name]`,

    'general': `Dear Property Manager,

I hope this message finds you well. I wanted to reach out regarding [Subject/Topic].

[Your message content - please customize based on your specific need or question]

I would appreciate your response when convenient.

Thank you for your time.

Best regards,
[Your Name]`
};

function useTemplate(templateType) {
    const messageTextarea = document.getElementById('message_text');
    messageTextarea.value = templates[templateType];
    
    // Update character count
    const event = new Event('input');
    messageTextarea.dispatchEvent(event);
    
    // Scroll to message textarea
    messageTextarea.scrollIntoView({ behavior: 'smooth' });
    messageTextarea.focus();
}

// Form submission with loading state
document.querySelector('form').addEventListener('submit', function() {
    const sendBtn = document.getElementById('send-btn');
    sendBtn.innerHTML = '<i class="bi bi-hourglass-split mr-2"></i>Sending...';
    sendBtn.disabled = true;
});
</script>
{% endblock %}